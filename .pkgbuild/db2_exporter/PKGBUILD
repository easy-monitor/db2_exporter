pkgname=db2_exporter
pkgver=VERSION  # placeholder
pkgver() {
    # 工具名: 打包-基础包
    # http://admin.easyops.local/tool/19398c5d3c4df767914d654b83206ec4
    echo $_easyopsver | tr -cd '[[:alnum:]]._-'
}
pkgrel=1
arch=('x86_64')
options=('!strip')
source=()

_goversion=1.16.2
_go_proj_domain="github.com/glinuz"
_go_proj_path="$_go_proj_domain/db2_exporter"

prepare() {
    export _projdir=$(readlink -f "$startdir/../..")

    cd $_projdir/src
    wget https://public.dhe.ibm.com/ibmdl/export/pub/software/data/db2/drivers/odbc_cli/linuxx64/linuxx64_odbc_cli.tar.gz
    tar -zxvf $_projdir/src/linuxx64_odbc_cli.tar.gz
    export CGO_LDFLAGS=-L${_projdir}/src/clidriver/lib
    export CGO_CFLAGS=-I${_projdir}/src/clidriver/include
    export LD_LIBRARY_PATH=${_projdir}/src/clidriver/lib:$LD_LIBRARY_PATH

    mkdir -p "$startdir/gopath/src/$_go_proj_domain"
    ln -snf "$_projdir" "$startdir/gopath/src/$_go_proj_path"
    eval "$(GIMME_GO_VERSION=$_goversion gimme)"
    unset GOPATH

    go env
}

build() {
    mkdir $startdir/bin
    go build -o $startdir/bin/${pkgname} $_go_proj_path
    ls -l $startdir/bin
}

package() {
    install -d "$pkgdir/bin"
    install -m755 "$startdir/bin/"* "$pkgdir/bin"

    install -d "$pkgdir/deploy"
    install -m755 "$startdir/deploy/"* "$pkgdir/deploy"

    install -d "$pkgdir/conf"
    cp -rf $_projdir/conf/* "$pkgdir/conf"

    install -d "$pkgdir/src"
    cp -rf $_projdir/src/* "$pkgdir/src"
}
